import{j as e}from"./index-gCpsBy-1.js";import{r as i,b as f}from"./react-Bkz_NVCf.js";import{D as se,k as M,a as te,N as U,l as ae}from"./lucide-2xugtfnM.js";import{R as F,L as le,X as ie,Y as re,T as B,a as E,b as ne,P as ce,c as de,C as oe}from"./recharts-DhQd0QmL.js";function g({label:c,value:d,icon:u,hint:n}){return e.jsxs("div",{className:"flex items-center justify-between p-5 rounded-xl border border-divider bg-panel/80 min-h-[118px]",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-[11px] text-dim",children:c}),e.jsx("div",{className:"text-2xl font-semibold text-bright mt-1",children:d}),n&&e.jsx("div",{className:"text-[11px] text-dim mt-1",children:n})]}),e.jsx("div",{className:"p-2 rounded-lg bg-surface border border-divider text-accent",children:u})]})}function xe({value:c}){const d=c>=0,u=`${d?"+":""}${c.toFixed(1)}%`;return e.jsx("span",{className:`ml-2 text-[10px] px-1.5 py-0.5 rounded ${d?"bg-emerald-900/40 text-emerald-300":"bg-rose-900/40 text-rose-300"}`,children:u})}const j=c=>{if(c<1024)return`${c} B`;const d=["KB","MB","GB","TB"];let u=-1,n=c;do n/=1024,u++;while(n>=1024&&u<d.length-1);return`${n.toFixed(n>=100?0:n>=10?1:2)} ${d[u]}`},w=c=>c.toLocaleString(),I=["#00bfa6","#5b8aff","#a88bfa","#7dd3fc","#34d399"];function ge(){var A,$,T,P;const[c]=i.useState(()=>new Date),[d,u]=i.useState([]),[n,z]=i.useState([]),[x,K]=i.useState([]),[v,O]=i.useState([]),[V,J]=i.useState(!0),[k,R]=i.useState(null),[p,S]=i.useState("7d"),[y,X]=i.useState(null),[o,Y]=i.useState(null),L=f.useRef(null),_=f.useRef(null),D=f.useRef(null),N=f.useRef(null),b=s=>{var t;return(t=s.current)==null?void 0:t.scrollIntoView({behavior:"smooth",block:"start"})},C=async()=>{try{R(null);const[s,t,m,r]=await Promise.all([fetch("/api/analytics/chat"),fetch("/api/analytics/files"),fetch("/api/analytics/engagement"),fetch("/api/analytics/network")]),a=await s.json(),l=await t.json(),Z=await m.json(),ee=await r.json();u(Array.isArray(a==null?void 0:a.messages_per_day)?a.messages_per_day:[]),z(Array.isArray(a==null?void 0:a.top_users)?a.top_users:[]),K(Array.isArray(l==null?void 0:l.types)?l.types:[]),O(Array.isArray(l==null?void 0:l.largest)?l.largest:[]),X(Z||null),Y(ee||null)}catch(s){R((s==null?void 0:s.message)||"Failed to load analytics")}finally{J(!1)}};i.useEffect(()=>{C();const s=setInterval(C,3e4);return()=>clearInterval(s)},[]);const h=i.useMemo(()=>{const s=new Date;s.setDate(s.getDate()-(p==="7d"?7:30));const m=d.filter(r=>new Date(r.date)>=s).map(r=>r.count);return m.length>=2?m:[3,5,2,8,6,9,7]},[d,p]),G=i.useMemo(()=>h.reduce((s,t)=>s+t,0),[h]),W=i.useMemo(()=>{if(h.length<2)return 0;const s=Math.floor(h.length/2),t=h.slice(0,s).reduce((r,a)=>r+a,0),m=h.slice(s).reduce((r,a)=>r+a,0);return t===0?100:(m-t)/t*100},[h]),q=i.useMemo(()=>{const s=new Date;return s.setDate(s.getDate()-(p==="7d"?7:30)),d.filter(t=>new Date(t.date)>=s).map(t=>({date:new Date(t.date).toLocaleDateString(void 0,{month:"short",day:"2-digit"}),count:t.count}))},[d,p]),H=i.useMemo(()=>x.reduce((s,t)=>s+(t.count||0),0),[x]),Q=i.useMemo(()=>x.reduce((s,t)=>s+(t.total_bytes||0),0),[x]);return e.jsx("div",{className:"w-full px-6 py-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-accent",children:"Analytics Dashboard"}),e.jsxs("div",{className:"text-xs text-dim",children:["Auto-refreshing every 30 seconds · ",c.toLocaleDateString()]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>window.print(),className:"px-3 py-2 text-sm rounded-md bg-accent text-black hover:bg-accent/90 transition-colors flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"})," Export PDF"]})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-dim",children:"Select range to compare trends"}),e.jsxs("div",{className:"inline-flex rounded-md border border-divider bg-panel/80 overflow-hidden",children:[e.jsx("button",{onClick:()=>S("7d"),className:`px-3 py-1.5 text-xs ${p==="7d"?"bg-surface text-accent":"text-bright/80 hover:bg-surface"}`,children:"Last 7 days"}),e.jsx("button",{onClick:()=>S("30d"),className:`px-3 py-1.5 text-xs border-l border-divider ${p==="30d"?"bg-surface text-accent":"text-bright/80 hover:bg-surface"}`,children:"Last 30 days"})]})]}),V&&e.jsx("div",{className:"text-xs text-dim",children:"Loading analytics…"}),k&&e.jsx("div",{className:"text-xs text-rose-400",children:k}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4",children:[e.jsxs("div",{title:"Total messages in selected range across all peers",onClick:()=>b(L),className:"cursor-pointer",children:[e.jsx(g,{label:`Messages (${p})`,value:w(G),icon:e.jsx(M,{className:"w-5 h-5"}),hint:"Across all peers"}),e.jsx(xe,{value:W})]}),e.jsx("div",{title:"Distinct IPs observed in data window",onClick:()=>b(N),className:"cursor-pointer",children:e.jsx(g,{label:"Active Users",value:`${n.length}`,icon:e.jsx(te,{className:"w-5 h-5"}),hint:"Distinct IPs observed"})}),e.jsx("div",{title:"Total uploaded files and storage footprint",onClick:()=>b(_),className:"cursor-pointer",children:e.jsx(g,{label:"Files",value:w(H),icon:e.jsx(M,{className:"w-5 h-5"}),hint:`Total size: ${j(Q)}`})}),e.jsx("div",{title:"P95 latency over last hour",onClick:()=>b(D),className:"cursor-pointer",children:e.jsx(g,{label:"Avg. Latency",value:((A=o==null?void 0:o.latency_ms)==null?void 0:A.p95)!=null?`${($=o==null?void 0:o.latency_ms)==null?void 0:$.p95} ms`:"—",icon:e.jsx(U,{className:"w-5 h-5"}),hint:"From /api/analytics/network"})}),e.jsx("div",{title:"Average session duration (10m idle)",onClick:()=>b(N),className:"cursor-pointer",children:e.jsx(g,{label:"Avg. Session",value:y?`${Math.floor(y.avg_session_seconds/60)}m ${y.avg_session_seconds%60}s`:"—",icon:e.jsx(ae,{className:"w-5 h-5"}),hint:"From /api/analytics/engagement"})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{ref:L,className:"rounded-2xl border border-divider bg-panel/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-bright",children:"Messages per day"}),e.jsx("span",{className:"text-xs text-dim",children:p==="7d"?"last 7 days":"last 30 days"})]}),e.jsx("div",{className:"mt-3 h-40",children:e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(le,{data:q,margin:{top:10,right:10,left:0,bottom:0},children:[e.jsx(ie,{dataKey:"date",tick:{fill:"#9ba0a8",fontSize:11},axisLine:{stroke:"#2a2d33"},tickLine:{stroke:"#2a2d33"}}),e.jsx(re,{tick:{fill:"#9ba0a8",fontSize:11},axisLine:{stroke:"#2a2d33"},tickLine:{stroke:"#2a2d33"},allowDecimals:!1}),e.jsx(B,{contentStyle:{background:"#1e2026",border:"1px solid #2a2d33",color:"#e8eaed"},labelStyle:{color:"#e8eaed"},itemStyle:{color:"#e8eaed"}}),e.jsx(E,{wrapperStyle:{color:"#e8eaed"}}),e.jsx(ne,{type:"monotone",dataKey:"count",name:"Messages",stroke:"#00bfa6",strokeWidth:2,dot:!1})]})})})]}),e.jsxs("div",{ref:_,className:"rounded-2xl border border-divider bg-panel/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-bright",children:"File usage by type"}),e.jsx("span",{className:"text-xs text-dim",children:"live"})]}),e.jsx("div",{className:"mt-2 h-48",children:e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(ce,{children:[e.jsx(de,{data:(x.length?x:[]).map(s=>({name:s.type.toUpperCase(),value:s.total_bytes})),dataKey:"value",nameKey:"name",innerRadius:40,outerRadius:70,paddingAngle:2,children:(x.length?x:[]).map((s,t)=>e.jsx(oe,{fill:I[t%I.length]},`cell-${t}`))}),e.jsx(B,{formatter:s=>j(Number(s)),contentStyle:{background:"#1e2026",border:"1px solid #2a2d33",color:"#e8eaed"},labelStyle:{color:"#e8eaed"},itemStyle:{color:"#e8eaed"}}),e.jsx(E,{wrapperStyle:{color:"#e8eaed"}})]})})}),x.length>0&&e.jsxs("div",{className:"mt-3 text-[11px] text-dim",children:["Total size: ",j(x.reduce((s,t)=>s+t.total_bytes,0))]})]}),e.jsxs("div",{ref:D,className:"rounded-2xl border border-divider bg-panel/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-bright",children:"Network stats"}),e.jsx("span",{className:"text-xs text-dim",children:"live"})]}),e.jsx("div",{className:"mt-4 grid grid-cols-1 gap-3",children:e.jsx(g,{label:"Latency (P95)",value:((T=o==null?void 0:o.latency_ms)==null?void 0:T.p95)!=null?`${(P=o==null?void 0:o.latency_ms)==null?void 0:P.p95} ms`:"—",icon:e.jsx(U,{className:"w-4 h-4"})})})]})]}),e.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-1 gap-4",children:e.jsxs("div",{ref:N,className:"rounded-2xl border border-divider bg-panel/80 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-bright mb-1",children:"Top active users"}),e.jsx("div",{className:"text-xs text-dim mb-3",children:"Distinct IPs with highest message counts"}),e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx("button",{className:"text-[11px] px-2 py-1 border border-divider rounded bg-panel hover:bg-panel/80",onClick:()=>{const t=["user,count",...(n.length?n:[]).map(l=>[l.user,String(l.count)]).map(l=>l.join(","))].join(`
`),m=new Blob([t],{type:"text/csv"}),r=URL.createObjectURL(m),a=document.createElement("a");a.href=r,a.download="top_users.csv",a.click(),URL.revokeObjectURL(r)},children:"Export CSV"})}),e.jsx("div",{className:"mt-1 divide-y divide-divider/80",children:(n.slice(0,5).length?n.slice(0,5):[{user:"192.168.0.103",count:23},{user:"192.168.1.8",count:12}]).map(s=>e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm",children:[e.jsx("span",{className:"text-bright/90",children:s.user}),e.jsxs("span",{className:"text-dim",children:[w(s.count)," msgs"]})]},s.user))})]})}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"rounded-2xl border border-divider bg-panel/80 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-bright mb-1",children:"Largest files"}),e.jsx("div",{className:"text-xs text-dim mb-3",children:"Top 10 by size · from uploads"}),e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx("button",{className:"text-[11px] px-2 py-1 border border-divider rounded bg-panel hover:bg-panel/80",onClick:()=>{const t=["filename,size,file_type,uploader_ip",...(v.length?v:[]).map(l=>[l.filename,j(l.bytes),l.file_type,l.uploader_ip]).map(l=>l.join(","))].join(`
`),m=new Blob([t],{type:"text/csv"}),r=URL.createObjectURL(m),a=document.createElement("a");a.href=r,a.download="largest_files.csv",a.click(),URL.revokeObjectURL(r)},children:"Export CSV"})}),e.jsx("div",{className:"mt-1 divide-y divide-divider/80",children:(v.length?v:[{filename:"Sample.pdf",bytes:1234567,uploader_ip:"192.168.0.103",file_type:"application/pdf"}]).map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-bright/90",title:s.filename,children:s.filename}),e.jsxs("div",{className:"text-[11px] text-dim",children:[s.file_type," · ",s.uploader_ip]})]}),e.jsx("span",{className:"text-dim",children:j(s.bytes)})]},`${s.filename}-${t}`))})]})})]})})}export{ge as default};
